{% extends "index.html" %}

{% block content %}
<!-- åˆ†æé¢„æµ‹æ ‡ç­¾é¡µ -->
<div class="tab-content active">
    <div class="card">
        <h2>âœ¨ å‘½ç†é¢„æµ‹å·¥å…·</h2>
        <p class="subtitle">è¯·è¾“å…¥æ‚¨çš„ä¸ªäººä¿¡æ¯å¼€å§‹åˆ†æ</p>
        
        {% if error %}
        <div class="error-message">{{ error }}</div>
        {% endif %}
        
        <form method="POST" action="{{ url_for('main.analyze') }}">
            <h3 style="color: #667eea; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0;">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="name">å§“åï¼š</label>
                    <input type="text" id="name" name="name" value="{{ request.form.get('name', '') }}" required>
                </div>
                
                <div class="form-group">
                    <label for="birthday">ç”Ÿæ—¥ï¼š</label>
                    <input type="date" id="birthday" name="birthday" value="{{ request.form.get('birthday', '') }}" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="mbti">MBTIç±»å‹ï¼š</label>
                    <select id="mbti" name="mbti" required>
                        <option value="">è¯·é€‰æ‹©MBTIç±»å‹</option>
                        <option value="INTJ" {% if request.form.get('mbti') == 'INTJ' %}selected{% endif %}>INTJ - å»ºç­‘å¸ˆ</option>
                        <option value="INTP" {% if request.form.get('mbti') == 'INTP' %}selected{% endif %}>INTP - é€»è¾‘å­¦å®¶</option>
                        <option value="ENTJ" {% if request.form.get('mbti') == 'ENTJ' %}selected{% endif %}>ENTJ - æŒ‡æŒ¥å®˜</option>
                        <option value="ENTP" {% if request.form.get('mbti') == 'ENTP' %}selected{% endif %}>ENTP - è¾©è®ºå®¶</option>
                        <option value="INFJ" {% if request.form.get('mbti') == 'INFJ' %}selected{% endif %}>INFJ - æå€¡è€…</option>
                        <option value="INFP" {% if request.form.get('mbti') == 'INFP' %}selected{% endif %}>INFP - è°ƒåœè€…</option>
                        <option value="ENFJ" {% if request.form.get('mbti') == 'ENFJ' %}selected{% endif %}>ENFJ - ä¸»äººå…¬</option>
                        <option value="ENFP" {% if request.form.get('mbti') == 'ENFP' %}selected{% endif %}>ENFP - ç«é€‰è€…</option>
                        <option value="ISTJ" {% if request.form.get('mbti') == 'ISTJ' %}selected{% endif %}>ISTJ - ç‰©æµå¸ˆ</option>
                        <option value="ISFJ" {% if request.form.get('mbti') == 'ISFJ' %}selected{% endif %}>ISFJ - å®ˆå«è€…</option>
                        <option value="ESTJ" {% if request.form.get('mbti') == 'ESTJ' %}selected{% endif %}>ESTJ - æ€»ç»ç†</option>
                        <option value="ESFJ" {% if request.form.get('mbti') == 'ESFJ' %}selected{% endif %}>ESFJ - æ‰§æ”¿å®˜</option>
                        <option value="ISTP" {% if request.form.get('mbti') == 'ISTP' %}selected{% endif %}>ISTP - é‰´èµå®¶</option>
                        <option value="ISFP" {% if request.form.get('mbti') == 'ISFP' %}selected{% endif %}>ISFP - æ¢é™©å®¶</option>
                        <option value="ESTP" {% if request.form.get('mbti') == 'ESTP' %}selected{% endif %}>ESTP - ä¼ä¸šå®¶</option>
                        <option value="ESFP" {% if request.form.get('mbti') == 'ESFP' %}selected{% endif %}>ESFP - è¡¨æ¼”è€…</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="birth_hour">å‡ºç”Ÿæ—¶è¾°ï¼ˆå°æ—¶ï¼Œ0-23ï¼‰ï¼š</label>
                    <input type="number" id="birth_hour" name="birth_hour" min="0" max="23" value="{{ request.form.get('birth_hour', '') }}" placeholder="ä¾‹å¦‚ï¼š14">
                </div>
            </div>
            
            <h3 style="color: #667eea; margin: 30px 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0;">ğŸ  é£æ°´ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="residence_direction">å±…ä½æ–¹ä½ï¼š</label>
                    <select id="residence_direction" name="residence_direction">
                        <option value="">è¯·é€‰æ‹©å±…ä½æ–¹ä½ï¼ˆå¯é€‰ï¼‰</option>
                        <option value="ä¸œ" {% if request.form.get('residence_direction') == 'ä¸œ' %}selected{% endif %}>ä¸œ</option>
                        <option value="å—" {% if request.form.get('residence_direction') == 'å—' %}selected{% endif %}>å—</option>
                        <option value="è¥¿" {% if request.form.get('residence_direction') == 'è¥¿' %}selected{% endif %}>è¥¿</option>
                        <option value="åŒ—" {% if request.form.get('residence_direction') == 'åŒ—' %}selected{% endif %}>åŒ—</option>
                        <option value="ä¸œåŒ—" {% if request.form.get('residence_direction') == 'ä¸œåŒ—' %}selected{% endif %}>ä¸œåŒ—</option>
                        <option value="ä¸œå—" {% if request.form.get('residence_direction') == 'ä¸œå—' %}selected{% endif %}>ä¸œå—</option>
                        <option value="è¥¿å—" {% if request.form.get('residence_direction') == 'è¥¿å—' %}selected{% endif %}>è¥¿å—</option>
                        <option value="è¥¿åŒ—" {% if request.form.get('residence_direction') == 'è¥¿åŒ—' %}selected{% endif %}>è¥¿åŒ—</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="house_orientation">æˆ¿å±‹æœå‘ï¼š</label>
                    <select id="house_orientation" name="house_orientation">
                        <option value="">è¯·é€‰æ‹©æˆ¿å±‹æœå‘ï¼ˆå¯é€‰ï¼‰</option>
                        <option value="æ­£ä¸œ" {% if request.form.get('house_orientation') == 'æ­£ä¸œ' %}selected{% endif %}>æ­£ä¸œ</option>
                        <option value="æ­£å—" {% if request.form.get('house_orientation') == 'æ­£å—' %}selected{% endif %}>æ­£å—</option>
                        <option value="æ­£è¥¿" {% if request.form.get('house_orientation') == 'æ­£è¥¿' %}selected{% endif %}>æ­£è¥¿</option>
                        <option value="æ­£åŒ—" {% if request.form.get('house_orientation') == 'æ­£åŒ—' %}selected{% endif %}>æ­£åŒ—</option>
                        <option value="ä¸œåŒ—" {% if request.form.get('house_orientation') == 'ä¸œåŒ—' %}selected{% endif %}>ä¸œåŒ—</option>
                        <option value="ä¸œå—" {% if request.form.get('house_orientation') == 'ä¸œå—' %}selected{% endif %}>ä¸œå—</option>
                        <option value="è¥¿å—" {% if request.form.get('house_orientation') == 'è¥¿å—' %}selected{% endif %}>è¥¿å—</option>
                        <option value="è¥¿åŒ—" {% if request.form.get('house_orientation') == 'è¥¿åŒ—' %}selected{% endif %}>è¥¿åŒ—</option>
                    </select>
                </div>
            </div>
            
            <h3 style="color: #667eea; margin: 30px 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0;">ğŸ”® å…¶ä»–å‘½ç†åˆ†æï¼ˆå¯é€‰ï¼‰</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" name="enable_bazi" value="1" {% if request.form.get('enable_bazi') == '1' %}checked{% endif %} style="margin-right: 8px; width: auto;">
                        å¯ç”¨å…«å­—åˆ†æ
                    </label>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" name="enable_tarot" value="1" {% if request.form.get('enable_tarot') == '1' %}checked{% endif %} style="margin-right: 8px; width: auto;">
                        å¯ç”¨å¡”ç½—ç‰Œå åœ
                    </label>
                </div>
            </div>
            
            <div style="margin-top: 30px; text-align: center;">
                <button type="submit" class="btn-primary" style="font-size: 18px; padding: 15px 40px;">ğŸ”® å¼€å§‹å…¨é¢åˆ†æ</button>
                <button type="reset" class="btn-secondary" style="font-size: 18px; padding: 15px 40px; margin-left: 10px;">é‡ç½®</button>
            </div>
        </form>
    </div>
    
    <!-- åˆ†æç»“æœ -->
    {% if result %}
    {% if result.history_id %}
    <!-- å†å²è®°å½•æ“ä½œæ ï¼ˆä»…åœ¨æŸ¥çœ‹å†å²è®°å½•æ—¶æ˜¾ç¤ºï¼‰ -->
    <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2 style="margin: 0; color: white;">ğŸ“œ å†å²è®°å½•è¯¦æƒ… - {{ result.name }}</h2>
                <p style="margin: 5px 0 0 0; color: rgba(255, 255, 255, 0.9); font-size: 14px;">æŸ¥çœ‹å’Œåˆ†æå†å²è®°å½•</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="{{ url_for('main.history') }}" class="btn-secondary" style="text-decoration: none; display: inline-block; padding: 8px 20px; font-size: 14px; background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3);">â† è¿”å›å†å²</a>
                <form method="POST" action="{{ url_for('main.delete_history', history_id=result.history_id) }}" 
                      onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼');" 
                      style="display: inline-block;">
                    <button type="submit" class="btn-delete" title="åˆ é™¤è®°å½•" style="padding: 8px 20px; font-size: 14px;">ğŸ—‘ï¸ åˆ é™¤è®°å½•</button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="two-column">
        <!-- å·¦ä¾§ï¼šå‘½ç†åˆ†æ -->
        <div class="card">
            <h2>ğŸŒŸ å‘½ç†åˆ†æ</h2>
            <div class="result-content">
                <h3 style="color: #667eea; margin-bottom: 15px;">ç”¨æˆ·ï¼š{{ result.name }}</h3>
                
                <div class="result-section">
                    <h4 style="color: #764ba2; margin-bottom: 10px;">âœ¨ æ˜Ÿåº§åˆ†æ</h4>
                    <div>{{ result.zodiac_analysis|replace('\n', '<br>')|safe }}</div>
                </div>
                
                <hr style="margin: 20px 0; border: 1px solid #e0e0e0;">
                
                <div class="result-section">
                    <h4 style="color: #764ba2; margin-bottom: 10px;">ğŸ§  MBTIåˆ†æ</h4>
                    <div>{{ result.mbti_analysis|replace('\n', '<br>')|safe }}</div>
                </div>
                
                <hr style="margin: 20px 0; border: 1px solid #e0e0e0;">
                
                <div class="result-section">
                    <h4 style="color: #764ba2; margin-bottom: 10px;">ğŸ“ˆ è¿åŠ¿é¢„æµ‹</h4>
                    <div>{{ result.fortune_prediction|replace('\n', '<br>')|safe }}</div>
                    {% if result.fortune_chart_html %}
                    <div style="margin-top: 20px;">
                        {{ result.fortune_chart_html|safe }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šé£æ°´åˆ†æã€å¿ƒç†å¥åº·ã€å…¶ä»–å‘½ç† -->
        <div class="card" style="display: flex; flex-direction: column;">
            {% if result.fengshui_analysis %}
            <div>
                <h2>ğŸ  é£æ°´åˆ†æ</h2>
                <div class="result-content" style="max-height: 350px;">
                    <div class="result-section">
                        {{ result.fengshui_analysis|replace('\n', '<br>')|safe }}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if result.mental_health_analysis %}
            <div style="margin-top: 15px;">
                <h2>ğŸ’š å¿ƒç†å¥åº·åˆ†æ</h2>
                <div class="result-content" style="max-height: 350px;">
                    <div class="result-section">
                        {{ result.mental_health_analysis|replace('\n', '<br>')|safe }}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if result.bazi_analysis %}
            <div style="margin-top: 15px;">
                <h2>ğŸ”® å…«å­—åˆ†æ</h2>
                <div class="result-content" style="max-height: 350px;">
                    <div class="result-section">
                        {{ result.bazi_analysis|replace('\n', '<br>')|safe }}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if result.tarot_reading %}
            <div style="margin-top: 15px;">
                <h2>ğŸƒ å¡”ç½—ç‰Œå åœ</h2>
                <div class="result-content" style="max-height: 350px;">
                    <div class="result-section">
                        {{ result.tarot_reading|replace('\n', '<br>')|safe }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    
    <!-- ä¸ªæ€§åŒ–æ¨èå’Œè¡ŒåŠ¨è®¡åˆ’ -->
    {% if result.recommendations or result.action_plan %}
    <div class="two-column">
        {% if result.recommendations %}
        <div class="card">
            <h2>ğŸ¯ ä¸ªäººåŒ–æ¨è</h2>
            <div class="result-content" style="max-height: 500px;">
                <div class="result-section">
                    {{ result.recommendations|replace('\n', '<br>')|safe }}
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if result.action_plan %}
        <div class="card">
            <h2>ğŸ“‹ è¡ŒåŠ¨è®¡åˆ’</h2>
            <div class="result-content" style="max-height: 500px;">
                <div class="result-section">
                    {{ result.action_plan|replace('\n', '<br>')|safe }}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- åé¦ˆè¡¨å•å’Œæ“ä½œæŒ‰é’® -->
    <div class="card">
        <h2>ğŸ’¬ ç”¨æˆ·åé¦ˆä¸æ“ä½œ</h2>
        <form method="POST" action="{{ url_for('main.feedback', history_id=result.history_id) }}">
            <div class="form-group">
                <label for="feedback">è¯·è¾“å…¥æ‚¨çš„åé¦ˆï¼š</label>
                <textarea id="feedback" name="feedback" rows="4" placeholder="è¯·åˆ†äº«æ‚¨çš„ä½¿ç”¨æ„Ÿå—å’Œå»ºè®®..."></textarea>
            </div>
            
            <div class="button-group">
                <button type="submit" class="btn-primary">æäº¤åé¦ˆ</button>
                <a href="{{ url_for('main.index') }}" class="btn-secondary" style="text-decoration: none; display: inline-block; padding: 12px 30px;">è¿”å›åˆ†æ</a>
                <a href="{{ url_for('main.history') }}" class="btn-secondary" style="text-decoration: none; display: inline-block; padding: 12px 30px;">æŸ¥çœ‹å†å²</a>
            </div>
        </form>
    </div>
    {% endif %}
</div>
{% endblock %}

